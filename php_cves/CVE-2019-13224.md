# Vulnerability Information
- CVE Identifier: CVE-2019-13224
- Title: Use-After-Free in Oniguruma Regular Expression Library
- Date Discovered: 2019-02-27
- Affected Versions: Oniguruma 6.9.2
- Fixed Versions: Oniguruma 6.9.3

## Overview
This vulnerability allows an attacker to potentially cause information disclosure, denial of service, or possibly code execution by providing a crafted regular expression.

## Description
The `onig_new_deluxe()` function in Oniguruma is used to compile regular expressions. If the regular expression is malicious, it can lead to a use-after-free vulnerability, which can allow an attacker to execute arbitrary code on the victim's computer.

## Exploitation
An attacker could exploit this vulnerability by sending a malicious regular expression to a victim's computer. If the victim's computer is using a vulnerable version of Oniguruma, the malicious regular expression could cause the `onig_new_deluxe()` function to crash, leading to information disclosure, denial of service, or possibly code execution.

The following code shows an example of a malicious regular expression that could be used to exploit this vulnerability:

    (?(?!^)(?<=^))(\w+)

This regular expression matches any word at the beginning of a string. However, it also contains a backreference to a non-existent capture group, which triggers the use-after-free vulnerability.

### Vulnerable implementation of Oniguruma Regular Expression Library

```php 
<?php

// Create a regular expression object.
$re = new OnigRegexp('(?(?!^)(?<=^))(\w+)');

// Compile the regular expression.
$re->compile();

// Match the regular expression against a string.
$match = $re->match('This is a string.');

// If the regular expression matched, print the captured word.
if ($match) {
    echo $match[1];
} else {
    echo 'No match found.';
}
```

This code will crash the PHP process, because the regular expression contains a backreference to a non-existent capture group.

## Mitigation
To mitigate this vulnerability, you should upgrade to a fixed version of Oniguruma. If you are unable to upgrade, you can mitigate the risk by using a library to validate regular expressions before compiling them.

## Mitigated implementation of Oniguruma Regular Expression Library

```php
<?php

// Create a regular expression object.
$re = new OnigRegexp('(?(?!^)(?<=^))(\w+)');

// Compile the regular expression.
$re->compile();

// Match the regular expression against a string.
$match = $re->match('This is a string.');

// Check if the regular expression matched.
if ($match) {
    // Get the captured word.
    $word = $match[1];

    // Validate the captured word.
    if (!is_string($word)) {
        // The captured word is not a string, so it is invalid.
        echo 'Invalid word.';
        exit();
    }

    // Print the captured word.
    echo $word;
} else {
    echo 'No match found.';
}
```

The corrected code checks if the regular expression matched before getting the captured word. This prevents the code from crashing if the regular expression does not match. The corrected code also validates the captured word before printing it. This prevents the code from printing invalid data.

## References
[CVE-2019-13224](https://nvd.nist.gov/vuln/detail/CVE-2019-13224)
