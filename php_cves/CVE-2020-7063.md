# Vulnerability Information
- CVE Identifier: CVE-2020-7063
- Title: Improper Preservation of Permissions in PHP PHAR Archives
- Date Discovered: 2020-03-18
- Affected Versions: PHP versions 7.2.x below 7.2.28, 7.3.x below 7.3.15 and 7.4.x below 7.4.3
- Fixed Versions: PHP versions 7.2.28, 7.3.15 and 7.4.3

## Overview
This vulnerability allows an attacker to escalate privileges on a victim's computer by exploiting a vulnerability in the PHP PHAR archive format.

## Description
When creating a PHAR archive using the PharData::buildFromIterator() function in PHP versions 7.2.x below 7.2.28, 7.3.x below 7.3.15 and 7.4.x below 7.4.3, the files are added with default permissions (0666, or all access) even if the original files on the filesystem were with more restrictive permissions. This means that an attacker can create a PHAR archive containing malicious files with elevated permissions, and then extract the archive on the victim's computer to escalate privileges.

## Exploitation
To exploit this vulnerability, an attacker would need to create a PHAR archive containing malicious files with elevated permissions. The attacker could then send the PHAR archive to the victim or trick the victim into downloading it. Once the victim extracts the PHAR archive, the malicious files will be executed with elevated permissions, allowing the attacker to escalate privileges.

### Vulnerable Code

```php
<?php

// Create a new PHAR archive.
$phar = new Phar('malicious.phar');

// Add a malicious file to the archive with elevated permissions.
$phar->addFile(__FILE__, 'malicious.php', Phar::EXTRACT_AS_FILE | Phar::PERM_0777);

// Close the archive.
$phar->close();
```

The vulnerable code allows an attacker to add a malicious file to the archive with elevated permissions. This can be exploited to escalate privileges on the victim's computer.

## Mitigation
To mitigate this vulnerability, you should upgrade to a fixed version of PHP. If you are unable to upgrade, you can mitigate the risk by using a library to validate the permissions of files before adding them to a PHAR archive.

## Mitigated Code

```php
<?php

// Create a new PHAR archive.
$phar = new Phar('malicious.phar');

// Validate the permissions of the file before adding it to the archive.
$filePermissions = fileperms(__FILE__);
if ($filePermissions & 0777 !== 0777) {
    throw new Exception('The file does not have the appropriate permissions.');
}

// Add the file to the archive with the same permissions that it has on the filesystem.
$phar->addFile(__FILE__, 'malicious.php', $filePermissions);

// Close the archive.
$phar->close();
```

The corrected code validates the permissions of the file before adding it to the archive. This prevents an attacker from adding a file to the archive with elevated permissions.

## References
[CVE-2020-7063](https://nvd.nist.gov/vuln/detail/CVE-2020-7063)
