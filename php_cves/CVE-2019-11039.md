# Vulnerability Information
- CVE Identifier: CVE-2019-11039
- Title: Out-of-Buffer Read in iconv_mime_decode_headers() Function
- Date Discovered: 2019-04-16
- Affected Versions: PHP versions 7.1.x below 7.1.30, 7.2.x below 7.2.19, and 7.3.x below 7.3.6
- Fixed Versions: PHP versions 7.1.30, 7.2.19, and 7.3.6

## Overview
This vulnerability allows an attacker to disclose information or cause a crash on a victim's computer by exploiting an out-of-buffer read in the `iconv_mime_decode_headers()` function.

## Description
The `iconv_mime_decode_headers()` function in PHP is used to decode MIME headers. If the input to the iconv_mime_decode_headers() function is malicious, it can lead to an out-of-buffer read, which can allow an attacker to disclose information or cause a crash on the victim's computer.

## Exploitation
An attacker could exploit this vulnerability by sending a malicious HTTP request to the victim's website. If the victim's website is using a vulnerable version of PHP, the attacker's HTTP request could cause the `iconv_mime_decode_headers()` function to crash, disclosing information or causing a crash on the victim's computer.

The following code shows an example of a malicious HTTP request that could be used to exploit this vulnerability:

```
GET /index.php HTTP/1.1
Host: example.com

Header: foo=bar
```

This HTTP request contains a malicious header. When the victim's website tries to parse the header, the iconv_mime_decode_headers() function will crash, disclosing information or causing a crash on the victim's computer.

### Vulnerable implementation of Out-of-Buffer Read in `iconv_mime_decode_headers()` Function

```php
<?php

function iconv_mime_decode_headers($encoded_headers) {
  $decoded_headers = array();

  foreach ($encoded_headers as $header) {
    $parts = explode(':', $header, 2);

    if (count($parts) == 2) {
      $name = $parts[0];
      $value = $parts[1];

      $decoded_name = iconv_mime_decode($name);
      $decoded_value = iconv_mime_decode($value);

      $decoded_headers[$decoded_name] = $decoded_value;
    }
  }

  return $decoded_headers;
}

$encoded_headers = array(
  'Header: foo=bar',
);

$decoded_headers = iconv_mime_decode_headers($encoded_headers);

var_dump($decoded_headers);
?>
```

This code is vulnerable to the out-of-buffer read vulnerability because the `iconv_mime_decode()` function does not properly check the size of the encoded string before decoding it. If the encoded string is very long, the iconv_mime_decode() function will attempt to allocate a buffer that is too small. This can cause the function to read memory outside of its allocated buffer, which can lead to a crash or information disclosure.

## Mitigation
To mitigate this vulnerability, you should upgrade to a fixed version of PHP. If you are unable to upgrade, you can mitigate the risk by using a library to validate MIME headers before parsing them.

## Mitigated implementation of Out-of-Buffer Read in `iconv_mime_decode_headers()` Function

```php
<?php

function iconv_mime_decode_headers($encoded_headers) {
  $decoded_headers = array();

  foreach ($encoded_headers as $header) {
    $parts = explode(':', $header, 2);

    if (count($parts) == 2) {
      $name = $parts[0];
      $value = $parts[1];

      $decoded_name = iconv_mime_decode($name);
      $decoded_value = iconv_mime_decode($value);

      if ($decoded_name === false || $decoded_value === false) {
        continue;
      }

      $decoded_headers[$decoded_name] = $decoded_value;
    }
  }

  return $decoded_headers;
}

$encoded_headers = array(
  'Header: foo=bar',
);

$decoded_headers = iconv_mime_decode_headers($encoded_headers);

var_dump($decoded_headers);
?>
```

The corrected version of the function checks the return value of the `iconv_mime_decode()` function before adding the decoded header to the `$decoded_headers` array. If the `iconv_mime_decode()` function returns false, the decoded header is not added to the array. This prevents the function from adding a malformed header to the array, which can prevent a crash or information disclosure.

## References
[CVE-2019-11039](https://nvd.nist.gov/vuln/detail/CVE-2019-11039)
