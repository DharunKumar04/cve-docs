# Vulnerability Information
- CVE Identifier: CVE-2022-31628
- Title: Infinite Loop in PHP Phar Uncompressor Code
- Date Discovered: 2022-08-04
- Affected Versions: PHP versions before 7.4.31, 8.0.24 and 8.1.11
- Fixed Versions: PHP versions 7.4.31, 8.0.24 and 8.1.11

## Overview
This vulnerability allows an attacker to cause a denial of service (DoS) on a victim's computer by exploiting an infinite loop in the PHP Phar uncompressor code.

## Description
The Phar uncompressor code in PHP is used to uncompress Phar archives. If the Phar archive contains a "quine" gzip file, the uncompressor code will recursively uncompress the file, resulting in an infinite loop.

## Exploitation
An attacker could exploit this vulnerability by creating a malicious Phar archive containing a `quine` gzip file. If the victim's computer tries to uncompress the Phar archive, the uncompressor code will enter an infinite loop, consuming all available system resources and causing the application to crash.

### Vulnerable code of Infinite Loop in PHP Phar Uncompressor Code implementation

```php
<?php

function uncompressPhar(string $pharPath): void
{
    $phar = new Phar($pharPath);
    foreach ($phar->getContents() as $file) {
        if (preg_match('/^(.*)\.gz$/', $file, $matches)) {
            $uncompressedFile = $matches[1];
            $phar->addFromString($uncompressedFile, gzdecode($phar->getFileContents($file)));
        }
    }
}

$pharPath = '/path/to/malicious.phar';
uncompressPhar($pharPath);
```

This code is vulnerable because it does not properly check for self-referential gzip files. When the code encounters a self-referential gzip file, it will recursively uncompress the file, resulting in an infinite loop.

## Mitigation
To mitigate this vulnerability, you should upgrade to a fixed version of PHP. If you are unable to upgrade, you can mitigate the risk by using a library to validate Phar archives before uncompressing them.

## Mitigated code of Infinite Loop in PHP Phar Uncompressor Code implementation

```php
<?php

function uncompressPhar(string $pharPath): void
{
    $phar = new Phar($pharPath);
    foreach ($phar->getContents() as $file) {
        if (preg_match('/^(.*)\.gz$/', $file, $matches)) {
            $uncompressedFile = $matches[1];
            if (file_exists($uncompressedFile)) {
                $phar->addFile($uncompressedFile);
            } else {
                $phar->addFromString($uncompressedFile, gzdecode($phar->getFileContents($file)));
            }
        }
    }
}

$pharPath = '/path/to/malicious.phar';
uncompressPhar($pharPath);
```

This code is corrected because it checks for the existence of the uncompressed file before adding it to the Phar archive. This prevents the code from entering an infinite loop when it encounters a self-referential gzip file.


## References
[CVE-2022-31628](https://nvd.nist.gov/vuln/detail/CVE-2022-31628)
