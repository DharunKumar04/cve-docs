# Vulnerability Information
- CVE Identifier: CVE-2020-7068
- Title: Use After Free in PHP phar_parse_zipfile() Function
- Date Discovered: 2020-01-15
- Affected Versions: PHP versions 7.2.x below 7.2.33, 7.3.x below 7.3.21 and 7.4.x below 7.4.9
- Fixed Versions: PHP versions 7.2.33, 7.3.21 and 7.4.9

## Overview
This vulnerability allows an attacker to cause a crash or information disclosure on a victim's computer by exploiting a use-after-free vulnerability in the PHP `phar_parse_zipfile()` function.

## Description
The `phar_parse_zipfile()` function in PHP is used to parse PHAR files. If the PHAR file is malicious, it can cause the `phar_parse_zipfile()` function to access freed memory, which can lead to a crash or information disclosure.

## Exploitation
An attacker could exploit this vulnerability by creating a malicious PHAR file and sending it to the victim. If the victim's computer is using a vulnerable version of PHP, the malicious PHAR file will cause the phar_parse_zipfile() function to crash or disclose information.

### Vulnerable code for the Use After Free vulnerability in the PHP `phar_parse_zipfile()` function

```php
<?php
function phar_parse_zipfile($filename) {
  $zip = new ZipArchive();
  if ($zip->open($filename) !== TRUE) {
    return false;
  }

  $entries = array();
  for ($i = 0; $i < $zip->numFiles; $i++) {
    $entry = $zip->statIndex($i);
    $entries[] = array(
      'name' => $entry['name'],
      'compressed_size' => $entry['comp_size'],
      'uncompressed_size' => $entry['size'],
    );
  }

  $zip->close();

  return $entries;
}
?>
```

The vulnerability is caused by the following line of code:

```php
$zip->close();
```

This line of code closes the ZipArchive object, which frees the memory used by the object. However, the `$entries` variable still contains references to pointers in the freed memory. This can lead to a use-after-free error if the `$entries` variable is used after the ZipArchive object has been closed.

## Mitigation
To mitigate this vulnerability, you should upgrade to a fixed version of PHP. If you are unable to upgrade, you can mitigate the risk by only opening PHAR files from trusted sources.

## Mitigated code for the Use After Free vulnerability in the PHP `phar_parse_zipfile()` function

```php
<?php
function phar_parse_zipfile($filename) {
  $zip = new ZipArchive();
  if ($zip->open($filename) !== TRUE) {
    return false;
  }

  $entries = array();
  for ($i = 0; $i < $zip->numFiles; $i++) {
    $entry = $zip->statIndex($i);
    $entries[] = array(
      'name' => $entry['name'],
      'compressed_size' => $entry['comp_size'],
      'uncompressed_size' => $entry['size'],
    );
  }

  // Copy the entries array to a new array before closing the ZipArchive object.
  $tmp_entries = $entries;

  $zip->close();

  return $tmp_entries;
}
?>
```

The corrected code copies the `$entries` array to a new array before closing the ZipArchive object. This prevents the `$entries` variable from containing references to pointers in the freed memory.

## References
[CVE-2020-7068](https://nvd.nist.gov/vuln/detail/CVE-2020-7068)
