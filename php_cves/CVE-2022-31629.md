# Vulnerability Information
- CVE Identifier: CVE-2022-31629
- Title: Cookie Forging Vulnerability in PHP
- Date Discovered: 2022-08-04
- Affected Versions: PHP versions before 7.4.31, 8.0.24 and 8.1.11
- Fixed Versions: PHP versions 7.4.31, 8.0.24 and 8.1.11

## Overview
This vulnerability allows an attacker to forge a cookie in a victim's browser which is treated as a `__Host- or __Secure`- cookie by PHP applications. This can lead to a variety of attacks, such as session hijacking, cross-site scripting (XSS), and cross-site request forgery (CSRF).

## Description
The PHP HTTP parser does not properly handle HTTP cookie names that contain certain characters. This can allow an attacker to set a standard insecure cookie in the victim's browser which is treated as a `__Host- or __Secure-` cookie by PHP applications.

## Exploitation
An attacker could exploit this vulnerability by setting a malicious cookie in the victim's browser. For example, the attacker could set a cookie with the name `__Host-example.com`. When the victim's browser visits a PHP website, the browser will send the cookie to the website. The PHP website will then treat the cookie as a secure cookie, even though it is not.

### Vulnerable code of Cookie Forging Vulnerability in PHP implementation

```php
<?php

// Set a malicious cookie in the victim's browser.
$cookie_name = $_GET['name'];
$cookie_value = $_GET['value'];
$cookie_expires = time() + 3600;
$cookie_path = '/';
$cookie_domain = '.example.com';
$cookie_secure = true;
$cookie_httponly = false;

setcookie($cookie_name, $cookie_value, $cookie_expires, $cookie_path, $cookie_domain, $cookie_secure, $cookie_httponly);

// Redirect the victim to a PHP website.
header('Location: https://example.com');
?>
```

The vulnerability in this code is that it allows an attacker to control the name of the cookie that is set. This means that an attacker could set a cookie with a name that is typically reserved for secure cookies, such as `__Host-example.com`.

## Mitigation
To mitigate this vulnerability, you should upgrade to a fixed version of PHP. If you are unable to upgrade, you can mitigate the risk by setting the `httponly` flag on all cookies that are supposed to be secure. This will prevent the cookies from being accessed by JavaScript, which can make it more difficult for an attacker to exploit the vulnerability.

## Mitigated implementation of Cookie Forging Vulnerability in PHP implementation

```php
<?php

// Set a malicious cookie in the victim's browser.
$cookie_name = $_GET['name'];
$cookie_value = $_GET['value'];
$cookie_expires = time() + 3600;
$cookie_path = '/';
$cookie_domain = '.example.com';
$cookie_secure = true;
$cookie_httponly = true;

// Validate the cookie name to prevent attackers from setting reserved cookies.
if (strpos($cookie_name, '__Host-') !== 0) {
    setcookie($cookie_name, $cookie_value, $cookie_expires, $cookie_path, $cookie_domain, $cookie_secure, $cookie_httponly);
} else {
    // Handle the error condition.
}

// Redirect the victim to a PHP website.
header('Location: https://example.com');
?>
```

The corrected code validates the cookie name before setting the cookie. This prevents attackers from setting reserved cookies, such as `__Host-example.com`.

## References
[CVE-2022-31629](https://nvd.nist.gov/vuln/detail/CVE-2022-31629)
